<html>
<!--
  - CopyRight:  (C) dGB Earth Sciences
  - Author:     A.H. Lammertink / A.H. Bril
  - Date:       Nov 2003
  - Contents:   Windows specific stuff for programmers
  - RCS:        $Id: windows.html,v 1.8 2004-01-14 12:24:32 arend Exp $
 -->

<body background="../backg.png"><title>Windows development [OpendTect Programmer's manual V1.0]</title>
<center>
<h1>OpendTect development on MS Windows</h1>
  <a href=#external>External installations</a>
| <a href=#setup>Setup</a>
| <a href=#buildod>Building OpendTect</a>
</center>
<br>
<img src="../hr.png" border=0>

<a name=external><h2>External installations</h2></a>

<p>The external installations can, in principle, be installed wherever you like. However, it is recommended to use the defaults. Otherwise, one or two configuration files have to be hand-edited.
If you choose to install some of the external installations elsewhere, it is strongly recommended to make sure that there are no spaces in any paths to external installations, because the make environment has not been prepared to handle these.</p> 

<h3>Cygwin</h3>
<p>The make system that is used with OpendTect requires some tools like a Unix-shell, sed, awk, etc. Since Cygwin provides all this, we use Cygwin as our shell/work environment, while still creating native Windows executables.</p>


<h4>Preparing the cygwin installation</h4>
<p>
If you did not install cygwin prior to installing OpendTect, it is likely that
an incomplete mount table is stored in the windows registry due to the fact
that some command-line cygwin tools are used internally by OpendTect.

It is necessary to check this before installing cygwin; otherwise cygwin will complain about not being able to find '/tmp'.

</p><p>

This can be avoided by deleting the following registry keys before installing cygwin with the registry editor (start - run - regedit):
<pre>
    HKEY_LOCAL_MACHINE\SOFTWARE\Cygnus Solutions
    HKEY_CURRENT_USER\Software\Cygnus Solutions
</pre>

If you don't like doing this by hand, you can make use of the cleanCygReg.reg
file that you can find in the windows binary directory
(default: C:\Program Files\OpendTect\bin\win\cleanCygReg.reg).
A simple double-click on this file will invoke the registry editor
which will make the changes for you.

</p>

<h4>Running the cygwin installer</h4>

<p>When you are sure the registry is ok, you can download the Cygwin installer from <a href="http://cygwin.com">http://cygwin.com</a> and run it.</p>
<p>After a few questions, you can select packages to install. Choose at least the following packages:</p>
<ul>
<li>make (development)</li>
<li>gcc (development)</li>
<li>gcc-g++ (development)</li>
<li>gcc-mingw-core (development)</li>
<li>gcc-mingw-g++ (development)</li>
<li>tcsh (shells)</li>
<li>perl (interpreters)</li>
<li>gawk (interpreters)</li>
</ul>
<p>Also recommended:</p>
<ul>
<li>cvs (development)</li>
<li>binutils (development)</li>
<li>bizon (development) (*)</li>
<li>flex (development) (*)</li>
<li>doxygen (development)</li>
<li>vim (editors) (**)</li>
<li>mc (editors) (**) = Norton Commander clone</li>
<li>openssh (net)</li>
<li>zip (archive)</li>
<li>unzip (archive)</li>
</ul>

Note: You can always re-start the cygwin installation program to add additional packages later or to update existing packages.


<p>(*) Bison and Flex are required to build OpendTect itself.</p>
<p>(**) You will need an editor that understands unix file format every now and then. If you're familiar with the good old Norton Commander, you might opt for mc, but one of the other editors in (editors) should also do. </p>


<a name=setup><h2>Setting up the environment</h2></a>
<p><a href="pmake.html">Pmake</a> is used to build both the system and to build plugins.
It requires a few environment variables to be setup and it expects a certain directory structure in your ODWork directory.</p>
<h3>Setup ODWork dir</h3>
<p>Before you can build anything, you have to setup the ODWork directory in such a way that Pmake can use it. The easiest way to do this is from within OpendTect, menu 'Utilities-Create Development Environment'.
Note that the OpendTect application window will freeze while the development environment is created.
'Create Development Environment' will also create an init script 'init.bash' in your ODWork directory that can easily be sourced from your .bashrc to setup your environment.
</p>
<p>It is strongly recommended to make sure that there are no spaces in the path to your ODWork directory. A good place for your ODWork directory is your cygwin home directory, which is by default at C:\cygwin\home\[user name]. 
The location of this directory can be easily found from a cygwin bash shell:
<pre>
    cd
    cygpath -w `pwd`
</pre>
</p>
<h3>Setup environment variables</h3>
<p>Once you have successfully created your ODWork directory, you have to setup a few environment variables: HDIR, WORK and GNUMAKE.</p>

<li>HDIR defines the platform you're working on. On windows, this should be set to win.</li>
<li>GNUMAKE gives the name of gnu make, usually just make or gmake.</li>
<li>WORK defines where your ODWork directory is.</li>

<p>Beside setting up these environment variables, you should source either the PMinit.csh or the PMinit.sh script present in the $WORK/Pmake/base directory.</p>

<p>If you have followed our instructions well, you can set the entire environment with a single setup script that is generated in the new ODWork directory. You can source the 'init.bash' script from your .bashrc (or 'init.csh',if you work with the non-default csh shell). 
If you have created your ODWork directory in your cygwin home, you can add the following line to the end of your .bashrc script:
<pre>
    source ~/ODWork/init.bash
</pre>
</p>

<h3>Building your own plugins</h3>
<h4>Testing the installation</h4>
<p>After you setup your environment, open a new cygwin bash shell and go to your ODWork directory. If all is well, the alias 'cwd' should bring you directly to your ODWork directory. Then go to the plugins directory and type 'make'. You should see something like this:</p>
<pre>
$ cd plugins/

Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork/plugins
$ make
make[1]: Entering directory `/cygdrive/c/cygwin/home/Administrator/ODWork/plugins/Hello'
  Making Hello / Microsoft Windows (Nov 27 13:18:33) DEBUG=no.
Compiling hellopi.cc ...
Ranlib on Hello.lib ...
Creating /cygdrive/c/cygwin/home/Administrator/ODWork/lib/win/O/Hello.dll ...
  Done !
make[1]: Leaving directory `/cygdrive/c/cygwin/home/Administrator/ODWork/plugins/Hello'

&lt;snip&gt;

make[1]: Entering directory `/cygdrive/c/cygwin/home/Administrator/ODWork/plugins/uiSeisIOSimple'
  Making uiSeisIOSimple / Microsoft Windows (Nov 27 13:19:14) DEBUG=no.
Compiling seisiosimple.cc ...
Compiling uiseisiosimple.cc ...
Compiling uiseisiosimplepi.cc ...
Ranlib on uiSeisIOSimple.lib ...
Creating /cygdrive/c/cygwin/home/Administrator/ODWork/lib/win/O/uiSeisIOSimple.dll
 ...
  Done !
make[1]: Leaving directory `/cygdrive/c/cygwin/home/Administrator/ODWork/plugins/uiSeisIOSimple'

Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork/plugins
$</pre>
<p>The libraries should now be made in $WORK/lib/win. We can check that, like this:</p>
<pre>
Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork/plugins
$ cdw

Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork
$ cd lib/win/

Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork/lib/win
$ ls
Coh.dll*    O@                 libuiSeisIOSimple.dll.a*  uiSeisIOSimple.dll*
Coh.lib*    libCoh.dll.a*      uiCoh.dll*                uiSeisIOSimple.lib*
G@          libHello.dll.a*    uiCoh.lib*
Hello.dll*  libuiCoh.dll.a*    uiHello.dll*
Hello.lib*  libuiHello.dll.a*  uiHello.lib*

Administrator@tazzie-win2k /cygdrive/c/cygwin/home/Administrator/ODWork/lib/win $
</pre>

<h4>Testing the newly compiled plugins</h4>

You can test your newly compiled plugins by loading them using the Utilities-plugins menu in OpendTect. For example, if you load the "Hello.dll" plugin, you should see "Hello World" on the OpendTect console window.
If you want to load one of the 'ui' plugins, you have to load the corresponding non-ui one first.

<a name=installplugins><h4>Installing your plugins</h4>

<p> The plugins are basically installed by copying them to the correct plugin subdirectory in either your personal '.od' settings directory, or in the program installation directory and making a configuration ".alo" file. 
This is the same on Unix and Windows, so please consult the plugins <a href="plugins.html#autoload">auto-load and installation</a> documentation for more details.
However, there are a few remarks about the location of your personal directory on windows. </p>

<p> Your 'Personal directory' is located at $HOMEDRIVE/$HOMEPATH if this is defined and is not equal to "C:\".
Otherwise, the location of the special windows folder "Application Data" is used.

You can find the location of special windows folders using the GetSpecFolder.exe program that you can find in the OpendTect installation directory:
<pre>
Administrator@dgb18-winxp ~
$ cd /cygdrive/c/Program\ Files/OpendTect/bin/win/

Administrator@dgb18-winxp /cygdrive/c/Program Files/OpendTect/bin/win
$ ./GetSpecFolder.exe AppData
C:\Documents and Settings\Administrator\Application Data

Administrator@dgb18-winxp /cygdrive/c/Program Files/OpendTect/bin/win
$
</pre>
</p>

<p>If you want your personal '.od' settings directory to be somewhere else, you can set the "DTECT_WINHOME" environment variable.</p>
<p>
You would have to set this using "My Computer - properties - advanced - Environment Variables"; otherwise it won't be available when you start OpendTect from the start-menu or the shortcut icons. You can set it to something like 'C:\cygwin\home\Administrator'</p>

<br>
<a name=dist><h2>Distributing your plugins:</h2>

<p>
The distribution of plugins is basically the same for Unix and windows. 
Just copy the .alo files into the plugins/platform directory
    (<code>$DTECT_APPL/plugins/$HDIR</code>, default
    <code>C:\Program Files\OpendTect\plugins\win</code> on windows)
and copy the actual plugins into the libs subdirectory.
</p><p>
In order to do this, we use .tar.gz files on Unix and inno-setup on windows, which can be obtained for free at: <a href="http://www.jrsoftware.org/isinfo.php">jrsoftware.org</a>.

</p><p>
Because we internally treat Windows as much like Unix as we can, we actually make a .tar.gz file for our windows plugins too, which is extracted to "d:\users\admin\rel\plugins\opendtect-1.0\", which forms the "Source" for Inno-Setup.

</p><p>

As an example, here is the Inno-setup file "dgbsetup.iss" that we use for our own dgb plugins.
Note that the OpendTect installation directory is stored in the registry and used as 'DefaultDirName':

<pre>

[Setup]
AppName=OpendTect
AppVerName=OpendTect 1.0
AppPublisher=De Groot-Bril Earth Sciences
AppPublisherURL=http://www.opendtect.org
AppSupportURL=http://www.opendtect.org
AppUpdatesURL=http://www.opendtect.org
DefaultDirName={reg:HKLM\OpendTect\Base\Settings,Path|{pf}\OpendTect}
DisableDirPage=yes
DefaultGroupName=OpendTect
AllowNoIcons=yes
OutputBaseFilename=dgb-opendtect-1_0_5
LicenseFile=d:\users\admin\rel\opendtect-1.0\LICENSE.txt


[Files]
Source: d:\users\admin\rel\plugins\opendtect-1.0\*; DestDir: {app}; Flags: recursesubdirs

</pre>


</p>

<a name=buildod><h2>Building OpendTect</h2>
<p>OpendTect relies on a number of external libraries to function. All these external libraries have been properly insulated, so there should be no need to recompile these if you want to build Open d-Tect yourself.</p>
<p>However, should you really want to, here are some guidelines.
Beware that especially compiling Coin's <u>SoQt</u> is quite tricky and can take a considerable amount of time and tweaking to get it right.</p>


<h3>Qt</h3>
<p>Qt does not officialy support <u>MinGW</u>, but as of version 3.2.1 it should build out of the box. Since Qt has it's own make-system, it cannot be compiled with cygwin's mingw compiler, so we have to use a native MinGW compiler, which can be downloaded at <a href="http://mingw.org/download.shtml">http://mingw.org/download.shtml</a>.
Make sure that the version number of the gcc compiler you use is the same as the one included in cygwin (i.e. test with gcc --version).
</p>
<h3>Pthreads</h3>
<p>The pthreads-win32 library can be downloaded from <a href="http://sources.redhat.com/pthreads-win32/">http://sources.redhat.com/pthreads-win32/</a>.
<p>You also might want to check out the faq: <a href="http://sources.redhat.com/pthreads-win32/faq.html">http://sources.redhat.com/pthreads-win32/faq.html</a></p>
<p>You need to copy the include files into cygwin's mingw include directory (default C:\cygwin\usr\include\mingw), the proper dll (pthreadGC.dll) into the bin directory (default C:\cygwin\bin) and the accompaning import library (libpthreadGC.a) into the mingw lib directory (default C:\cygwin\lib\mingw)</p>
<h3>Coin</h3>
<p>Coin does not officially support anything other then VC++.</p>
<p>However, older versions of Coin required cygwin as a build environment. This was necessary in order to make use of the command-line MSVC compiler, cl.exe, which was called using a wrapper program (wrapmsvc).</p>
<p>Fortunately, the Coin config scripts can handle the cygwin MinGW compiler (i.e. gcc -mno-cygwin) quite well.</p>
<p>Coin compiles pretty straightforward, just configure &amp; make from a cygwin shell, making sure the -mno-cygwin is added to the c flags.</p>
<p>It might be that the libtool complains about not being able to find certain dlls. This cost me a lot of time, until I found out that the required dlls have to be in the search path ($PATH). Passing a -L&lt;path to dll&gt; did not work.</p>

<br>
<img src="../hr.png" border=0>

<p>
<center>
  <a href="index.html">Index</a>
| <a href="overview.html">Overview</a>
| <a href="plugins.html">Plugins</a>
| <a href="pmake.html">Pmake</a>
| <a href="http://www.opendtect.org">opendtect.org</a>
</center>
</p>

</body>
</html>
