#!/bin/csh
#__Pmake________________________________________________________________________
#
# This script creates a shared object lib from a number of input libraries
# SCCS %Z%%M%   Version: %I%  Date: %G% - %U%
#_______________________________________________________________________________


if ( $#argv < 3 ) then
	echo "Usage: $0 Input_lib Output_sharedlib [win: deffile] Linker_and_flags"
	exit 1
endif

set tmpdir=`$PMAKE/bin/get_temp_file_name`


set inplibs=""
foreach lib ( $* )

    if ( "$lib" == "--output" ) goto inplibs_done

    if ( ! -r "$lib" ) then
	    echo "$0 : Input lib $lib cannot be accessed"
	    exit 1
    endif

    set inplibs="$inplibs $lib"
    shift

end
inplibs_done:
shift

set outlib=$1
shift


if ( $HDIR == "win" ) then
    set deffile=$1
    shift
endif

if ( ! -d $tmpdir ) mkdir $tmpdir
if ( ! -d $tmpdir ) then
	echo "$0 : Cannot create $tmpdir"
	exit 1
endif

cd $tmpdir

foreach lib ( $inplibs )
	ar x $lib `ar t $lib`
end

if ( $HDIR != "win") then

    #echo "Executing:" $* *.o -o $outlib
    $* *.o -o $outlib
    cd /tmp

else

    pwd

    #echo "implib: " $inplib 
    #echo o2dll.sh $* -o $outlib *.o
    #o2dll.sh $* -o $outlib *.o

    # o2dll.sh -o aap *.o -L/cygdrive/d/users/admin/work/bin/win/so -lmsvcrt -L/c/work/appman/fftw/lib -lfftw3f -lstdc++ -lpthreadGC -lshlwapi -lwsock32

    #    echo "Generating def file"

	#/usr/local/bin/dlltool-wrap --add-indirect --export-all-symbols \
    #    dlltool --add-indirect --export-all-symbols \
    #	    --output-def $deffile *.o


    echo "Executing:" $* *.o -o $outlib
    $* *.o -o $outlib

endif

rm -rf $tmpdir


exit 0
